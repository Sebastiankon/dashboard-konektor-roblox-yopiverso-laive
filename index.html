<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Yopiverso - Laive</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .brand-gradient {
            background: linear-gradient(135deg, #E31E24 0%, #FF6B6B 100%);
        }
        .insights-gradient {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }
        .brand-kpi-gradient {
            background: linear-gradient(135deg, #4A90E2 0%, #7ED321 100%);
        }
        .chart-container {
            height: 300px;
        }
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            margin: 4px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="brand-gradient text-white p-6 mb-6">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold mb-2">Dashboard Yopiverso - Laive</h1>
            <p class="text-red-100">Desarrollado por Konektor Chile | Sebasti√°n Wagner - Key Account Manager</p>
            <p class="text-red-100 text-sm">Dashboard actualizado autom√°ticamente con datos de Roblox Analytics</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 space-y-6">
        <!-- Date Filters -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4"><i class="fas fa-calendar-alt text-red-500 mr-2"></i>Filtrar por Fecha</h3>
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium">Desde:</label>
                    <input type="date" id="startDate" class="border rounded px-3 py-1 text-sm">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium">Hasta:</label>
                    <input type="date" id="endDate" class="border rounded px-3 py-1 text-sm">
                </div>
                <button id="applyFilter" class="bg-red-500 text-white px-4 py-2 rounded text-sm hover:bg-red-600 transition-colors">
                    <i class="fas fa-filter mr-1"></i>Aplicar
                </button>
                <button id="resetFilter" class="bg-gray-500 text-white px-4 py-2 rounded text-sm hover:bg-gray-600 transition-colors">
                    <i class="fas fa-undo mr-1"></i>Todo el per√≠odo
                </button>
                <div class="flex items-center gap-2 ml-4 text-sm text-gray-600">
                    <i class="fas fa-info-circle"></i>
                    <span id="filterInfo">Mostrando todo el per√≠odo</span>
                </div>
            </div>
            <!-- Debug info -->
            <div id="debugInfo" class="debug-info mt-4" style="display: none;">
                <strong>Debug del Filtro:</strong><br>
                <span id="debugText">-</span>
            </div>
            <button id="toggleDebug" class="mt-2 text-xs text-gray-500 hover:text-gray-700">Mostrar/Ocultar Debug</button>
        </div>

        <!-- Main KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
            <div class="metric-card bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-600" id="usuariosActivos">-</div>
                <div class="text-sm text-gray-600">Usuarios Activos</div>
            </div>
            <div class="metric-card bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="nuevosUsuarios">-</div>
                <div class="text-sm text-gray-600">Nuevos Usuarios</div>
            </div>
            <div class="metric-card bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="tiempoSesion">-</div>
                <div class="text-sm text-gray-600">Tiempo Sesi√≥n (min)</div>
            </div>
            <div class="metric-card bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="retencion">-</div>
                <div class="text-sm text-gray-600">Retenci√≥n D√≠a 1</div>
            </div>
            <div class="metric-card bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-yellow-600" id="visitasTotales">-</div>
                <div class="text-sm text-gray-600">Visitas Totales</div>
            </div>
            <div class="metric-card bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-indigo-600" id="totalSpent">-</div>
                <div class="text-sm text-gray-600">Inversi√≥n Total</div>
            </div>
        </div>

        <!-- Additional KPIs Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="metric-card bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="playsTotal">-</div>
                <div class="text-sm text-gray-600">Plays Totales</div>
            </div>
            <div class="metric-card bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-pink-600" id="cppPromedio">-</div>
                <div class="text-sm text-gray-600">CPP Promedio</div>
            </div>
            <div class="metric-card bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-orange-600" id="roiVisitas">-</div>
                <div class="text-sm text-gray-600">ROI Visitas/Dolar</div>
            </div>
            <div class="metric-card bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-teal-600" id="cpv">-</div>
                <div class="text-sm text-gray-600">CPV (Costo/Visita)</div>
            </div>
        </div>

        <!-- Insights Clave del Per√≠odo -->
        <div class="insights-gradient rounded-lg shadow-lg p-6 text-white">
            <h3 class="text-xl font-bold mb-4"><i class="fas fa-lightbulb mr-2"></i>Insights Clave del Per√≠odo</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-3xl font-bold" id="roiPublicitario">-</div>
                    <div class="text-sm opacity-90">ROI Plays/Dolar</div>
                    <div class="text-xs opacity-75">Plays por d√≥lar invertido</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold" id="roiVisitasDolar">-</div>
                    <div class="text-sm opacity-90">ROI Visitas/Dolar</div>
                    <div class="text-xs opacity-75">Visitas por d√≥lar invertido</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold" id="traficoOrganico">-</div>
                    <div class="text-sm opacity-90">Tr√°fico Org√°nico</div>
                    <div class="text-xs opacity-75">Visitas org√°nicas vs pagadas</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold" id="eficiencia">-</div>
                    <div class="text-sm opacity-90">Eficiencia</div>
                    <div class="text-xs opacity-75">Clicks que se convierten en plays</div>
                </div>
            </div>
        </div>

        <!-- KPIs de Marca -->
        <div class="brand-kpi-gradient rounded-lg shadow-lg p-6 text-white">
            <h3 class="text-xl font-bold mb-4"><i class="fas fa-star mr-2"></i>KPIs de Interacci√≥n de Marca</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="text-center">
                    <div class="text-3xl font-bold" id="tiempoInteraccionMarca">-</div>
                    <div class="text-sm opacity-90">Tiempo de Interacci√≥n</div>
                    <div class="text-xs opacity-75">Visitas Totales √ó Tiempo Promedio (minutos)</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold" id="costoMinutoInteraccion">-</div>
                    <div class="text-sm opacity-90">Costo por Minuto</div>
                    <div class="text-xs opacity-75">Gasto Total √∑ Tiempo de Interacci√≥n</div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Usuarios Activos Chart -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Usuarios Activos Diarios</h3>
                <div class="chart-container">
                    <canvas id="usuariosActivosChart"></canvas>
                </div>
            </div>

            <!-- Nuevos Usuarios Chart -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Nuevos Usuarios por D√≠a</h3>
                <div class="chart-container">
                    <canvas id="nuevosUsuariosChart"></canvas>
                </div>
            </div>

            <!-- Tiempo Sesi√≥n Chart -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Tiempo de Sesi√≥n Promedio</h3>
                <div class="chart-container">
                    <canvas id="tiempoSesionChart"></canvas>
                </div>
            </div>

            <!-- Visitas Totales Chart -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Crecimiento de Visitas Totales</h3>
                <div class="chart-container">
                    <canvas id="visitasTotalesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Campaign Comparison -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">Rendimiento por Tipo de Campa√±a</h3>
            <div class="chart-container">
                <canvas id="campaignComparisonChart"></canvas>
            </div>
        </div>

        <!-- Top Campaigns Table -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">Top 5 Campa√±as por Plays</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="text-left p-3">Campa√±a</th>
                            <th class="text-right p-3">Plays</th>
                            <th class="text-right p-3">Gasto</th>
                            <th class="text-right p-3">CPP</th>
                            <th class="text-center p-3">Objetivo</th>
                        </tr>
                    </thead>
                    <tbody id="campaignsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-500 text-sm py-6">
            <p>Dashboard actualizado: <span id="lastUpdate">-</span></p>
            <p>Contacto: <a href="https://meetings.hubspot.com/sebastian592" class="text-red-500 hover:underline">Sebasti√°n Wagner - meetings.hubspot.com/sebastian592</a></p>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let filteredData = null;
        let charts = {};
        let debugMode = false;

        // Funci√≥n para logging de debug
        function debugLog(message) {
            if (debugMode) {
                console.log(`üêõ DEBUG: ${message}`);
            }
        }

        function updateDebugInfo(text) {
            document.getElementById('debugText').innerHTML = text;
        }

        // Load data from JSON
        async function loadData() {
            try {
                document.body.classList.add('loading');
                const response = await fetch('./data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                dashboardData = await response.json();
                filteredData = JSON.parse(JSON.stringify(dashboardData));
                
                console.log('‚úÖ Data loaded successfully:', dashboardData);
                debugLog('Dashboard data loaded with ' + dashboardData.experienceMetrics.length + ' experience metrics');
                debugLog('Campaign count: ' + dashboardData.campaigns.length);
                
                initializeDashboard();
                document.body.classList.remove('loading');
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                document.body.classList.remove('loading');
                alert('Error al cargar los datos. Aseg√∫rate de que el archivo data.json est√© disponible.');
            }
        }

        function initializeDashboard() {
            if (!dashboardData) return;
            
            // Set date range
            const dates = dashboardData.experienceMetrics.map(d => d.fecha).sort();
            document.getElementById('startDate').value = dates[0];
            document.getElementById('endDate').value = dates[dates.length - 1];
            
            debugLog(`Date range set: ${dates[0]} to ${dates[dates.length - 1]}`);
            
            // Set last update
            document.getElementById('lastUpdate').textContent = dashboardData.lastUpdate || 'N/A';
            
            updateDashboard();
        }

        function updateDashboard() {
            if (!filteredData) return;
            
            debugLog('Updating dashboard with filtered data');
            updateKPIs();
            updateInsights();
            updateBrandKPIs();
            updateCharts();
            updateCampaignsTable();
        }

        function updateKPIs() {
            const lastMetric = filteredData.experienceMetrics[filteredData.experienceMetrics.length - 1];
            const adMetrics = filteredData.advertisingMetrics;
            
            debugLog(`Last metric date: ${lastMetric.fecha}, visits: ${lastMetric.visitasTotales}`);
            
            document.getElementById('usuariosActivos').textContent = lastMetric.usuariosActivosDiarios.toLocaleString();
            document.getElementById('nuevosUsuarios').textContent = lastMetric.nuevosUsuarios.toLocaleString();
            document.getElementById('tiempoSesion').textContent = lastMetric.tiempoSesionPromedio.toFixed(1);
            document.getElementById('retencion').textContent = (lastMetric.retencionDia1 * 100).toFixed(1) + '%';
            document.getElementById('visitasTotales').textContent = lastMetric.visitasTotales.toLocaleString();
            document.getElementById('totalSpent').textContent = ' + adMetrics.totalSpent.toLocaleString();
            
            // Additional KPIs
            document.getElementById('playsTotal').textContent = adMetrics.totalPlays.toLocaleString();
            document.getElementById('cppPromedio').textContent = ' + adMetrics.costPerPlay.toFixed(3);
            
            // ROI Visitas/Dolar
            const roiVisitas = adMetrics.totalSpent > 0 ? (lastMetric.visitasTotales / adMetrics.totalSpent) : 0;
            document.getElementById('roiVisitas').textContent = roiVisitas.toFixed(1);
            
            // CPV (Costo por Visita)
            const cpv = lastMetric.visitasTotales > 0 ? (adMetrics.totalSpent / lastMetric.visitasTotales) : 0;
            document.getElementById('cpv').textContent = ' + cpv.toFixed(4);
        }

        function updateInsights() {
            const insights = filteredData.insightsClave;
            const lastMetric = filteredData.experienceMetrics[filteredData.experienceMetrics.length - 1];
            const adMetrics = filteredData.advertisingMetrics;
            
            document.getElementById('roiPublicitario').textContent = insights.roiPublicitario.toFixed(1);
            
            // ROI Visitas/Dolar
            const roiVisitasDolar = adMetrics.totalSpent > 0 ? (lastMetric.visitasTotales / adMetrics.totalSpent) : 0;
            document.getElementById('roiVisitasDolar').textContent = roiVisitasDolar.toFixed(1);
            
            document.getElementById('traficoOrganico').textContent = insights.traficoOrganico.toFixed(1) + '%';
            document.getElementById('eficiencia').textContent = insights.eficienciaConversion.toFixed(1) + '%';
        }

        function updateBrandKPIs() {
            const brandKPIs = filteredData.brandKPIs;
            
            document.getElementById('tiempoInteraccionMarca').textContent = brandKPIs.tiempoInteraccionMarca.toLocaleString() + ' min';
            document.getElementById('costoMinutoInteraccion').textContent = ' + brandKPIs.costoPorMinutoInteraccion.toFixed(4);
        }

        function updateCharts() {
            createUsuariosActivosChart();
            createNuevosUsuariosChart();
            createTiempoSesionChart();
            createVisitasTotalesChart();
            createCampaignComparisonChart();
        }

        function createUsuariosActivosChart() {
            const ctx = document.getElementById('usuariosActivosChart').getContext('2d');
            
            if (charts.usuariosActivos) {
                charts.usuariosActivos.destroy();
            }
            
            const data = filteredData.experienceMetrics;
            
            charts.usuariosActivos = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.fecha).toLocaleDateString('es-ES')),
                    datasets: [{
                        label: 'Usuarios Activos',
                        data: data.map(d => d.usuariosActivosDiarios),
                        borderColor: '#E31E24',
                        backgroundColor: 'rgba(227, 30, 36, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createNuevosUsuariosChart() {
            const ctx = document.getElementById('nuevosUsuariosChart').getContext('2d');
            
            if (charts.nuevosUsuarios) {
                charts.nuevosUsuarios.destroy();
            }
            
            const data = filteredData.experienceMetrics;
            
            charts.nuevosUsuarios = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => new Date(d.fecha).toLocaleDateString('es-ES')),
                    datasets: [{
                        label: 'Nuevos Usuarios',
                        data: data.map(d => d.nuevosUsuarios),
                        backgroundColor: '#4A90E2',
                        borderColor: '#4A90E2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createTiempoSesionChart() {
            const ctx = document.getElementById('tiempoSesionChart').getContext('2d');
            
            if (charts.tiempoSesion) {
                charts.tiempoSesion.destroy();
            }
            
            const data = filteredData.experienceMetrics;
            
            charts.tiempoSesion = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.fecha).toLocaleDateString('es-ES')),
                    datasets: [{
                        label: 'Tiempo Sesi√≥n (min)',
                        data: data.map(d => d.tiempoSesionPromedio),
                        borderColor: '#7ED321',
                        backgroundColor: 'rgba(126, 211, 33, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createVisitasTotalesChart() {
            const ctx = document.getElementById('visitasTotalesChart').getContext('2d');
            
            if (charts.visitasTotales) {
                charts.visitasTotales.destroy();
            }
            
            const data = filteredData.experienceMetrics;
            
            charts.visitasTotales = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.fecha).toLocaleDateString('es-ES')),
                    datasets: [{
                        label: 'Visitas Totales',
                        data: data.map(d => d.visitasTotales),
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createCampaignComparisonChart() {
            const ctx = document.getElementById('campaignComparisonChart').getContext('2d');
            
            if (charts.campaignComparison) {
                charts.campaignComparison.destroy();
            }
            
            // Group campaigns by objective
            const campaignGroups = {};
            filteredData.campaigns.forEach(campaign => {
                if (!campaignGroups[campaign.objective]) {
                    campaignGroups[campaign.objective] = {
                        plays: 0,
                        spent: 0,
                        campaigns: 0
                    };
                }
                campaignGroups[campaign.objective].plays += campaign.adjustedPlays || campaign.plays;
                campaignGroups[campaign.objective].spent += campaign.adjustedSpent || campaign.spent;
                campaignGroups[campaign.objective].campaigns += 1;
            });
            
            const labels = Object.keys(campaignGroups);
            const playsData = labels.map(label => campaignGroups[label].plays);
            const spentData = labels.map(label => campaignGroups[label].spent);
            
            charts.campaignComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Plays',
                        data: playsData,
                        backgroundColor: '#E31E24',
                        yAxisID: 'y'
                    }, {
                        label: 'Gasto ($)',
                        data: spentData,
                        backgroundColor: '#FFD700',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function updateCampaignsTable() {
            const tableBody = document.getElementById('campaignsTableBody');
            tableBody.innerHTML = '';
            
            // Sort campaigns by plays (descending) and take top 5
            const topCampaigns = filteredData.campaigns
                .filter(c => (c.adjustedPlays || c.plays) > 0)
                .sort((a, b) => (b.adjustedPlays || b.plays) - (a.adjustedPlays || a.plays))
                .slice(0, 5);
            
            topCampaigns.forEach(campaign => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const actualPlays = campaign.adjustedPlays || campaign.plays;
                const actualSpent = campaign.adjustedSpent || campaign.spent;
                const cpp = actualPlays > 0 ? (actualSpent / actualPlays) : 0;
                
                row.innerHTML = `
                    <td class="p-3 font-medium">${campaign.name}</td>
                    <td class="p-3 text-right">${actualPlays.toLocaleString()}</td>
                    <td class="p-3 text-right">${actualSpent.toFixed(2)}</td>
                    <td class="p-3 text-right">${cpp.toFixed(3)}</td>
                    <td class="p-3 text-center">
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                            ${campaign.objective}
                        </span>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // FUNCI√ìN MEJORADA PARA FILTRAR POR FECHAS CON PRORRATEO CORREGIDO
        function filterDataByDate() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate || !dashboardData) {
                console.error('‚ùå Faltan datos para filtrar');
                return;
            }
            
            debugLog('üîç INICIANDO FILTRO DE FECHAS CON PRORRATEO CORREGIDO');
            debugLog(`üìÖ Rango seleccionado: ${startDate} a ${endDate}`);
            
            // Calcular d√≠as del per√≠odo filtrado
            const filterStartMs = new Date(startDate).getTime();
            const filterEndMs = new Date(endDate).getTime();
            const filterDays = Math.ceil((filterEndMs - filterStartMs) / (1000 * 60 * 60 * 24)) + 1;
            
            // Filter experience metrics
            const filteredExperience = dashboardData.experienceMetrics.filter(metric => {
                return metric.fecha >= startDate && metric.fecha <= endDate;
            });
            
            debugLog(`üìà M√©tricas de experiencia filtradas: ${filteredExperience.length} de ${dashboardData.experienceMetrics.length}`);
            debugLog(`üìÖ D√≠as en el per√≠odo: ${filterDays}`);
            
            // Filtrar y prorratear campa√±as
            let filteredCampaigns = [];
            let totalAdjustedSpent = 0;
            let totalAdjustedImpressions = 0;
            let totalAdjustedClicks = 0;
            let totalAdjustedPlays = 0;
            
            let debugDetails = [];
            
            dashboardData.campaigns.forEach((campaign, index) => {
                const campaignStart = campaign.startDate;
                const campaignEnd = campaign.endDate || "2099-12-31"; // Si no tiene fecha fin, asumimos que sigue activa
                
                // Verificar si la campa√±a tiene overlap con el per√≠odo filtrado
                if (campaignStart <= endDate && campaignEnd >= startDate) {
                    // Calcular el per√≠odo efectivo de la campa√±a dentro del filtro
                    const effectiveStart = campaignStart > startDate ? campaignStart : startDate;
                    const effectiveEnd = campaignEnd < endDate ? campaignEnd : endDate;
                    
                    const effectiveStartMs = new Date(effectiveStart).getTime();
                    const effectiveEndMs = new Date(effectiveEnd).getTime();
                    const effectiveDays = Math.ceil((effectiveEndMs - effectiveStartMs) / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Calcular d√≠as totales de la campa√±a
                    const campaignStartMs = new Date(campaignStart).getTime();
                    const campaignEndMs = new Date(campaignEnd).getTime();
                    const campaignTotalDays = Math.ceil((campaignEndMs - campaignStartMs) / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Calcular factor de prorrateo
                    const prorateFactor = effectiveDays / campaignTotalDays;
                    
                    // Crear copia de la campa√±a con valores prorrateados
                    const adjustedCampaign = {
                        ...campaign,
                        adjustedSpent: campaign.spent * prorateFactor,
                        adjustedImpressions: Math.round(campaign.impressions * prorateFactor),
                        adjustedClicks: Math.round(campaign.clicks * prorateFactor),
                        adjustedPlays: Math.round(campaign.plays * prorateFactor),
                        prorateFactor: prorateFactor,
                        effectiveDays: effectiveDays,
                        campaignTotalDays: campaignTotalDays,
                        effectiveStart: effectiveStart,
                        effectiveEnd: effectiveEnd
                    };
                    
                    filteredCampaigns.push(adjustedCampaign);
                    totalAdjustedSpent += adjustedCampaign.adjustedSpent;
                    totalAdjustedImpressions += adjustedCampaign.adjustedImpressions;
                    totalAdjustedClicks += adjustedCampaign.adjustedClicks;
                    totalAdjustedPlays += adjustedCampaign.adjustedPlays;
                    
                    debugDetails.push(`‚úÖ ${campaign.name.substring(0, 30)}...<br>
                        &nbsp;&nbsp;üìÖ Campa√±a: ${campaignStart} ‚Üí ${campaignEnd}<br>
                        &nbsp;&nbsp;üìÖ Efectivo: ${effectiveStart} ‚Üí ${effectiveEnd}<br>
                        &nbsp;&nbsp;üìä D√≠as: ${effectiveDays}/${campaignTotalDays} (${(prorateFactor * 100).toFixed(1)}%)<br>
                        &nbsp;&nbsp;üí∞ Gasto: ${campaign.spent.toFixed(2)} ‚Üí ${adjustedCampaign.adjustedSpent.toFixed(2)}<br>
                        &nbsp;&nbsp;üéØ Plays: ${campaign.plays} ‚Üí ${adjustedCampaign.adjustedPlays}`);
                } else {
                    debugDetails.push(`‚ùå ${campaign.name.substring(0, 30)}... (fuera del rango)<br>
                        &nbsp;&nbsp;üìÖ Campa√±a: ${campaignStart} ‚Üí ${campaignEnd}<br>
                        &nbsp;&nbsp;üìÖ Filtro: ${startDate} ‚Üí ${endDate}`);
                }
            });
            
            debugLog(`üí∞ RESUMEN DEL FILTRO CON PRORRATEO:`);
            debugLog(`üìä Campa√±as incluidas: ${filteredCampaigns.length} de ${dashboardData.campaigns.length}`);
            debugLog(`üí∏ Gasto total prorrateado: ${totalAdjustedSpent.toFixed(2)}`);
            debugLog(`üéØ Plays totales prorrateados: ${totalAdjustedPlays.toLocaleString()}`);
            
            // Actualizar debug info en la interfaz
            const debugText = `
                <strong>Per√≠odo:</strong> ${startDate} a ${endDate} (${filterDays} d√≠as)<br>
                <strong>Experiencia:</strong> ${filteredExperience.length} m√©tricas filtradas<br>
                <strong>Campa√±as:</strong> ${filteredCampaigns.length} de ${dashboardData.campaigns.length} incluidas<br>
                <strong>Gasto total:</strong> ${totalAdjustedSpent.toFixed(2)}<br>
                <strong>Plays totales:</strong> ${totalAdjustedPlays.toLocaleString()}<br><br>
                <strong>Detalle de campa√±as:</strong><br>
                ${debugDetails.join('<br>')}
            `;
            updateDebugInfo(debugText);
            
            // Calcular m√©tricas agregadas
            const overallCTR = totalAdjustedImpressions > 0 ? (totalAdjustedClicks / totalAdjustedImpressions * 100) : 0;
            const overallPlayRate = totalAdjustedImpressions > 0 ? (totalAdjustedPlays / totalAdjustedImpressions * 100) : 0;
            const costPerPlay = totalAdjustedPlays > 0 ? (totalAdjustedSpent / totalAdjustedPlays) : 0;
            const costPerClick = totalAdjustedClicks > 0 ? (totalAdjustedSpent / totalAdjustedClicks) : 0;
            const clickToPlayRate = totalAdjustedClicks > 0 ? (totalAdjustedPlays / totalAdjustedClicks * 100) : 0;
            const playsPerDollar = totalAdjustedSpent > 0 ? (totalAdjustedPlays / totalAdjustedSpent) : 0;
            
            // Recalculate brand KPIs and insights for filtered period
            const lastExperienceMetric = filteredExperience[filteredExperience.length - 1];
            if (lastExperienceMetric) {
                const tiempoInteraccionMarca = lastExperienceMetric.visitasTotales * lastExperienceMetric.tiempoSesionPromedio;
                const costoPorMinutoInteraccion = tiempoInteraccionMarca > 0 ? (totalAdjustedSpent / tiempoInteraccionMarca) : 0;
                
                // Estimar tr√°fico org√°nico
                const playsOrganicosEstimados = Math.max(0, lastExperienceMetric.visitasTotales - totalAdjustedPlays);
                const traficoOrganico = lastExperienceMetric.visitasTotales > 0 ? 
                    (playsOrganicosEstimados / lastExperienceMetric.visitasTotales * 100) : 0;
                
                filteredData = {
                    ...dashboardData,
                    experienceMetrics: filteredExperience,
                    campaigns: filteredCampaigns,
                    advertisingMetrics: {
                        totalImpressions: Math.round(totalAdjustedImpressions),
                        totalClicks: Math.round(totalAdjustedClicks),
                        totalPlays: Math.round(totalAdjustedPlays),
                        totalSpent: Math.round(totalAdjustedSpent * 100) / 100,
                        overallCTR: Math.round(overallCTR * 100) / 100,
                        overallPlayRate: Math.round(overallPlayRate * 100) / 100,
                        costPerPlay: Math.round(costPerPlay * 1000) / 1000,
                        costPerClick: Math.round(costPerClick * 1000) / 1000,
                        clickToPlayRate: Math.round(clickToPlayRate * 100) / 100,
                        playsPerDollar: Math.round(playsPerDollar * 10) / 10
                    },
                    brandKPIs: {
                        tiempoInteraccionMarca: Math.round(tiempoInteraccionMarca),
                        costoPorMinutoInteraccion: Math.round(costoPorMinutoInteraccion * 10000) / 10000
                    },
                    insightsClave: {
                        roiPublicitario: Math.round(playsPerDollar * 10) / 10,
                        traficoOrganico: Math.round(traficoOrganico * 10) / 10,
                        eficienciaConversion: Math.round(clickToPlayRate * 10) / 10
                    }
                };
                
                // Actualizar informaci√≥n del filtro
                document.getElementById('filterInfo').textContent = 
                    `Mostrando ${filterDays} d√≠as (${new Date(startDate).toLocaleDateString('es-ES')} - ${new Date(endDate).toLocaleDateString('es-ES')})`;
            }
            
            updateDashboard();
        }

        // Event listeners
        document.getElementById('applyFilter').addEventListener('click', filterDataByDate);
        
        document.getElementById('resetFilter').addEventListener('click', () => {
            if (dashboardData) {
                const dates = dashboardData.experienceMetrics.map(d => d.fecha).sort();
                document.getElementById('startDate').value = dates[0];
                document.getElementById('endDate').value = dates[dates.length - 1];
                filteredData = JSON.parse(JSON.stringify(dashboardData));
                document.getElementById('filterInfo').textContent = 'Mostrando todo el per√≠odo';
                updateDebugInfo('Sin filtros aplicados - mostrando datos completos');
                updateDashboard();
            }
        });

        // Toggle debug mode
        document.getElementById('toggleDebug').addEventListener('click', () => {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugMode ? 'block' : 'none';
            
            if (debugMode) {
                console.log('üêõ Debug mode enabled');
                updateDebugInfo('Debug mode activado - datos cargados completamente');
            } else {
                console.log('üêõ Debug mode disabled');
            }
        });

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
