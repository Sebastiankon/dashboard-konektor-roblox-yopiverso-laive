<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Ejecutivo Yopiverso - Laive</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .executive-gradient {
            background: linear-gradient(135deg, #E31E24 0%, #B71C1C 50%, #FF6B6B 100%);
        }
        .roi-gradient {
            background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 50%, #81C784 100%);
        }
        .engagement-gradient {
            background: linear-gradient(135deg, #1565C0 0%, #2196F3 50%, #64B5F6 100%);
        }
        .performance-gradient {
            background: linear-gradient(135deg, #F57C00 0%, #FF9800 50%, #FFB74D 100%);
        }
        .metric-hero {
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
        }
        .metric-hero:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            background: rgba(255,255,255,1);
        }
        .chart-container {
            height: 300px;
        }
        .compact-chart {
            height: 200px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-excellent { background: #4CAF50; }
        .status-good { background: #FFC107; }
        .status-attention { background: #FF9800; }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-red-500 mb-4"></div>
            <div class="text-lg font-semibold text-gray-700">Cargando Dashboard Ejecutivo...</div>
            <div class="text-sm text-gray-500">Procesando datos de Yopiverso</div>
        </div>
    </div>

    <!-- Executive Header -->
    <div class="executive-gradient text-white p-8 mb-8">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-2">Yopiverso Campaign Dashboard</h1>
                    <p class="text-red-100 text-lg">Campaña Laive en Roblox • Reporte Ejecutivo</p>
                    <p class="text-red-200 text-sm mt-1">
                        <i class="fas fa-sync-alt mr-1"></i>
                        Actualizado: <span id="lastUpdate">Cargando...</span> • 
                        <i class="fas fa-chart-line mr-1"></i>
                        Konektor Chile
                    </p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold" id="campaignStatus">ACTIVA</div>
                    <div class="text-sm opacity-90">Estado de Campaña</div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 space-y-8">
        
        <!-- Filtros Ejecutivos -->
        <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-filter text-red-500 mr-2"></i>Período de Análisis
                </h3>
                <div class="flex gap-4 items-center">
                    <input type="date" id="startDate" class="border-2 border-gray-200 rounded-lg px-4 py-2 text-sm focus:border-red-500 focus:outline-none">
                    <span class="text-gray-500">hasta</span>
                    <input type="date" id="endDate" class="border-2 border-gray-200 rounded-lg px-4 py-2 text-sm focus:border-red-500 focus:outline-none">
                    <button id="applyFilter" class="bg-red-500 text-white px-6 py-2 rounded-lg text-sm hover:bg-red-600 transition-all font-semibold">
                        <i class="fas fa-search mr-1"></i>Analizar
                    </button>
                    <button id="resetFilter" class="bg-gray-500 text-white px-6 py-2 rounded-lg text-sm hover:bg-gray-600 transition-all">
                        <i class="fas fa-refresh mr-1"></i>Reset
                    </button>
                </div>
            </div>
            <div id="filterInfo" class="mt-3 text-sm text-blue-600 font-medium"></div>
        </div>

        <!-- KPIs Ejecutivos Hero -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <div class="metric-hero rounded-2xl p-5 text-center border border-gray-200">
                <div class="text-3xl font-bold text-red-600 mb-2" id="visitasTotales">-</div>
                <div class="text-sm font-semibold text-gray-600 mb-1">ALCANCE TOTAL</div>
                <div class="text-xs text-gray-500">Visitas Acumuladas</div>
                <div class="mt-2">
                    <span class="status-indicator status-excellent"></span>
                    <span class="text-xs text-gray-600">Meta: 200K</span>
                </div>
            </div>
            
            <div class="metric-hero rounded-2xl p-5 text-center border border-gray-200">
                <div class="text-3xl font-bold text-blue-600 mb-2" id="totalPlays">-</div>
                <div class="text-sm font-semibold text-gray-600 mb-1">PLAYS TOTALES</div>
                <div class="text-xs text-gray-500">Engagement Generado</div>
                <div class="mt-2">
                    <span class="status-indicator status-excellent"></span>
                    <span class="text-xs text-gray-600">Target: 100K+</span>
                </div>
            </div>
            
            <div class="metric-hero rounded-2xl p-5 text-center border border-gray-200">
                <div class="text-3xl font-bold text-green-600 mb-2" id="totalImpressions">-</div>
                <div class="text-sm font-semibold text-gray-600 mb-1">IMPRESIONES</div>
                <div class="text-xs text-gray-500">Alcance Publicitario</div>
                <div class="mt-2">
                    <span class="status-indicator status-good"></span>
                    <span class="text-xs text-gray-600">Millones</span>
                </div>
            </div>
            
            <div class="metric-hero rounded-2xl p-5 text-center border border-gray-200">
                <div class="text-3xl font-bold text-orange-600 mb-2" id="cppMetric">-</div>
                <div class="text-sm font-semibold text-gray-600 mb-1">CPP</div>
                <div class="text-xs text-gray-500">Costo por Play</div>
                <div class="mt-2">
                    <span class="status-indicator status-excellent"></span>
                    <span class="text-xs text-gray-600">Benchmark: $0.08</span>
                </div>
            </div>
            
            <div class="metric-hero rounded-2xl p-5 text-center border border-gray-200">
                <div class="text-3xl font-bold text-purple-600 mb-2" id="cpvMetric">-</div>
                <div class="text-sm font-semibold text-gray-600 mb-1">CPV</div>
                <div class="text-xs text-gray-500">Costo por Visita</div>
                <div class="mt-2">
                    <span class="status-indicator status-good"></span>
                    <span class="text-xs text-gray-600">Eficiencia</span>
                </div>
            </div>
            
            <div class="metric-hero rounded-2xl p-5 text-center border border-gray-200">
                <div class="text-3xl font-bold text-indigo-600 mb-2" id="totalInvestment">-</div>
                <div class="text-sm font-semibold text-gray-600 mb-1">INVERSIÓN TOTAL</div>
                <div class="text-xs text-gray-500">Presupuesto Ejecutado</div>
                <div class="mt-2">
                    <span class="status-indicator status-good"></span>
                    <span class="text-xs text-gray-600">Budget: $10K</span>
                </div>
            </div>
        </div>

        <!-- Sección ROI y Eficiencia -->
        <div class="roi-gradient rounded-2xl p-8 text-white">
            <h3 class="text-2xl font-bold mb-6">
                <i class="fas fa-chart-line mr-3"></i>Rendimiento e Impacto Financiero
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                    <div class="text-4xl font-bold mb-2" id="roiCampaign">-</div>
                    <div class="text-lg opacity-90 mb-1">ROI Publicitario</div>
                    <div class="text-sm opacity-75">Plays por USD</div>
                    <div class="mt-3 text-sm bg-white bg-opacity-20 rounded-lg p-2">
                        Meta: <span class="font-semibold">15+ plays/USD</span>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-4xl font-bold mb-2" id="costPerPlay">-</div>
                    <div class="text-lg opacity-90 mb-1">Costo por Play</div>
                    <div class="text-sm opacity-75">Eficiencia publicitaria</div>
                    <div class="mt-3 text-sm bg-white bg-opacity-20 rounded-lg p-2">
                        vs. Benchmark: <span id="benchmarkComparison">Cargando...</span>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-4xl font-bold mb-2" id="organicTraffic">-</div>
                    <div class="text-lg opacity-90 mb-1">Tráfico Orgánico</div>
                    <div class="text-sm opacity-75">Impacto viral generado</div>
                    <div class="mt-3 text-sm bg-white bg-opacity-20 rounded-lg p-2">
                        Multiplicador: <span id="viralMultiplier">Cargando...</span>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-4xl font-bold mb-2" id="conversionRate">-</div>
                    <div class="text-lg opacity-90 mb-1">Tasa Conversión</div>
                    <div class="text-sm opacity-75">Click-to-Play Rate</div>
                    <div class="mt-3 text-sm bg-white bg-opacity-20 rounded-lg p-2">
                        Industria: <span id="industryAverage">25-35%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección Impacto de Marca -->
        <div class="engagement-gradient rounded-2xl p-8 text-white">
            <h3 class="text-2xl font-bold mb-6">
                <i class="fas fa-heart mr-3"></i>Impacto e Interacción de Marca
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="text-center">
                    <div class="text-5xl font-bold mb-2" id="brandInteractionTime">-</div>
                    <div class="text-lg opacity-90 mb-1">Tiempo Total de Interacción</div>
                    <div class="text-sm opacity-75">Minutos acumulados con la marca</div>
                    <div class="mt-4">
                        <div class="bg-white bg-opacity-20 rounded-lg p-3">
                            <div class="text-sm mb-1">Equivalente a:</div>
                            <div class="text-lg font-semibold" id="tvEquivalent">Cargando...</div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-5xl font-bold mb-2" id="costPerMinute">-</div>
                    <div class="text-lg opacity-90 mb-1">Costo por Minuto</div>
                    <div class="text-sm opacity-75">Eficiencia de branding</div>
                    <div class="mt-4">
                        <div class="bg-white bg-opacity-20 rounded-lg p-3">
                            <div class="text-sm mb-1">vs. TV Traditional:</div>
                            <div class="text-lg font-semibold" id="tvComparison">Cargando...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance de Campañas -->
        <div class="performance-gradient rounded-2xl p-8 text-white">
            <h3 class="text-2xl font-bold mb-6">
                <i class="fas fa-trophy mr-3"></i>Top Performance Campaigns
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Top Campaigns Table -->
                <div class="bg-white bg-opacity-10 rounded-xl p-6">
                    <h4 class="text-lg font-semibold mb-4">Mejores Campañas por ROI</h4>
                    <div class="space-y-3" id="topCampaignsList">
                        <div class="text-center text-sm opacity-75 py-8">Cargando campañas...</div>
                    </div>
                </div>
                
                <!-- Campaign Performance Chart -->
                <div class="bg-white bg-opacity-10 rounded-xl p-6">
                    <h4 class="text-lg font-semibold mb-4">Distribución por Objetivo</h4>
                    <div class="compact-chart">
                        <canvas id="campaignObjectivesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tendencias Estratégicas -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-trending-up text-green-500 mr-2"></i>Evolución de Alcance
                </h3>
                <div class="chart-container">
                    <canvas id="reachEvolutionChart"></canvas>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-clock text-blue-500 mr-2"></i>Tiempo de Sesión por Día
                </h3>
                <div class="chart-container">
                    <canvas id="sessionTimeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Insights Ejecutivos -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h3 class="text-2xl font-semibold mb-6 text-gray-800">
                <i class="fas fa-lightbulb text-yellow-500 mr-3"></i>Executive Insights
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="executiveInsights">
                <div class="text-center text-gray-500 py-8">Generando insights...</div>
            </div>
        </div>

        <!-- Footer Ejecutivo -->
        <div class="text-center text-gray-600 py-8">
            <div class="flex items-center justify-center gap-8 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-shield-alt text-green-500 mr-2"></i>
                    <span class="text-sm">Datos en Tiempo Real</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                    <span class="text-sm">Analytics Avanzado</span>
                </div>
                <div class="flex items-center">
                    <i class="fas fa-rocket text-purple-500 mr-2"></i>
                    <span class="text-sm">Optimización Continua</span>
                </div>
            </div>
            <p class="text-sm text-gray-500">
                Dashboard Ejecutivo desarrollado por 
                <a href="https://meetings.hubspot.com/sebastian592" class="text-red-500 hover:underline font-semibold">
                    Konektor Chile
                </a> • 
                Sebastián Wagner, Key Account Manager
            </p>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let filteredData = null;
        let charts = {};

        // Debug function
        function logError(message, error) {
            console.error(`[Dashboard Error] ${message}:`, error);
        }

        function logInfo(message, data) {
            console.log(`[Dashboard Info] ${message}:`, data);
        }

        // Load data from separate JSON files
        async function loadData() {
            try {
                logInfo("Iniciando carga de datos", "Buscando archivos JSON");
                
                const [mainResponse, campaignsResponse] = await Promise.all([
                    fetch('./data-main.json'),
                    fetch('./data-campaigns.json')
                ]);
                
                logInfo("Respuestas recibidas", {
                    main: mainResponse.status,
                    campaigns: campaignsResponse.status
                });
                
                if (!mainResponse.ok) {
                    throw new Error(`Error cargando data-main.json: ${mainResponse.status} ${mainResponse.statusText}`);
                }
                
                if (!campaignsResponse.ok) {
                    throw new Error(`Error cargando data-campaigns.json: ${campaignsResponse.status} ${campaignsResponse.statusText}`);
                }
                
                const mainData = await mainResponse.json();
                const campaignsData = await campaignsResponse.json();
                
                logInfo("Datos parseados", {
                    mainDataKeys: Object.keys(mainData),
                    campaignsCount: campaignsData.campaigns ? campaignsData.campaigns.length : 0
                });
                
                // Validate data structure
                if (!mainData.experienceMetrics || !Array.isArray(mainData.experienceMetrics)) {
                    throw new Error("Estructura de data-main.json inválida: falta experienceMetrics");
                }
                
                if (!campaignsData.campaigns || !Array.isArray(campaignsData.campaigns)) {
                    throw new Error("Estructura de data-campaigns.json inválida: falta campaigns");
                }
                
                dashboardData = {
                    ...mainData,
                    campaigns: campaignsData.campaigns
                };
                
                filteredData = JSON.parse(JSON.stringify(dashboardData));
                
                logInfo("Dashboard data combinado exitosamente", {
                    experienceMetrics: dashboardData.experienceMetrics.length,
                    campaigns: dashboardData.campaigns.length,
                    lastUpdate: dashboardData.lastUpdate
                });
                
                // Hide loading overlay
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
                
                initializeExecutiveDashboard();
                
            } catch (error) {
                logError("Error en loadData", error);
                
                // Hide loading overlay and show error
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.innerHTML = `
                        <div class="text-center">
                            <div class="text-red-500 text-6xl mb-4"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="text-xl font-semibold text-gray-700 mb-2">Error al cargar datos</div>
                            <div class="text-sm text-gray-500 mb-4">${error.message}</div>
                            <button onclick="location.reload()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                <i class="fas fa-refresh mr-1"></i>Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }

        function initializeExecutiveDashboard() {
            try {
                if (!dashboardData) {
                    throw new Error("dashboardData is null");
                }
                
                logInfo("Inicializando dashboard", "Configurando fechas y UI");
                
                const dates = dashboardData.experienceMetrics.map(d => d.fecha).sort();
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                const lastUpdateSpan = document.getElementById('lastUpdate');
                
                if (startDateInput && endDateInput) {
                    startDateInput.value = dates[0];
                    endDateInput.value = dates[dates.length - 1];
                }
                
                // FIX: Mejorar el formateo de la fecha de actualización
                if (lastUpdateSpan && dashboardData.lastUpdate) {
                    // Crear fecha directamente desde el string en formato YYYY-MM-DD
                    const [year, month, day] = dashboardData.lastUpdate.split('-');
                    const updateDate = new Date(year, month - 1, day); // month - 1 porque JavaScript usa 0-11 para meses
                    
                    // Formatear en español
                    const formattedDate = updateDate.toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: '2-digit', 
                        year: 'numeric'
                    });
                    
                    lastUpdateSpan.textContent = formattedDate;
                    
                    logInfo("Fecha de actualización configurada", {
                        original: dashboardData.lastUpdate,
                        formateada: formattedDate
                    });
                }
                
                updateExecutiveDashboard();
                
                logInfo("Dashboard inicializado correctamente", "Actualizando métricas");
                
            } catch (error) {
                logError("Error en initializeExecutiveDashboard", error);
            }
        }

        function updateExecutiveDashboard() {
            try {
                if (!filteredData) {
                    throw new Error("filteredData is null");
                }
                
                updateExecutiveKPIs();
                updateROIMetrics();
                updateBrandImpact();
                updateCampaignPerformance();
                updateTrendCharts();
                updateExecutiveInsights();
                
                logInfo("Dashboard actualizado completamente", "Todas las secciones");
                
            } catch (error) {
                logError("Error en updateExecutiveDashboard", error);
            }
        }

        function safeUpdateElement(id, content, fallback = '-') {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = content;
            } else {
                logError(`Elemento no encontrado: ${id}`, null);
            }
        }

        function updateExecutiveKPIs() {
            try {
                const lastMetric = filteredData.experienceMetrics[filteredData.experienceMetrics.length - 1];
                const adMetrics = filteredData.advertisingMetrics;
                
                if (!lastMetric || !adMetrics) {
                    throw new Error("Métricas faltantes en filteredData");
                }
                
                // Visitas totales (acumulativas del CSV)
                safeUpdateElement('visitasTotales', lastMetric.visitasTotales.toLocaleString());
                
                // Plays totales
                safeUpdateElement('totalPlays', adMetrics.totalPlays.toLocaleString());
                
                // Impresiones totales (en formato M para millones)
                const impressionsM = (adMetrics.totalImpressions / 1000000).toFixed(1);
                safeUpdateElement('totalImpressions', impressionsM + 'M');
                
                // CPP (Costo por Play)
                safeUpdateElement('cppMetric', '$' + adMetrics.costPerPlay.toFixed(3));
                
                // CPV (Costo por Visita) - calculado como inversión total / visitas totales
                const cpv = lastMetric.visitasTotales > 0 ? (adMetrics.totalSpent / lastMetric.visitasTotales) : 0;
                safeUpdateElement('cpvMetric', '$' + cpv.toFixed(3));
                
                // Inversión total
                safeUpdateElement('totalInvestment', '$' + (adMetrics.totalSpent / 1000).toFixed(1) + 'K');
                
                // ROI publicitario (se movió a la sección ROI)
                safeUpdateElement('roiCampaign', adMetrics.playsPerDollar.toFixed(1));
                
                logInfo("KPIs ejecutivos actualizados", {
                    visitas: lastMetric.visitasTotales,
                    plays: adMetrics.totalPlays,
                    impressions: impressionsM + 'M',
                    cpp: adMetrics.costPerPlay,
                    cpv: cpv
                });
                
            } catch (error) {
                logError("Error en updateExecutiveKPIs", error);
            }
        }

        function updateROIMetrics() {
            try {
                const adMetrics = filteredData.advertisingMetrics;
                const insights = filteredData.insightsClave;
                
                safeUpdateElement('costPerPlay', '$' + adMetrics.costPerPlay.toFixed(3));
                safeUpdateElement('organicTraffic', insights.traficoOrganico.toFixed(1) + '%');
                safeUpdateElement('conversionRate', insights.eficienciaConversion.toFixed(1) + '%');
                
                // Comparaciones vs benchmark
                const benchmarkCPP = 0.080;
                const comparison = ((benchmarkCPP - adMetrics.costPerPlay) / benchmarkCPP * 100);
                safeUpdateElement('benchmarkComparison', comparison > 0 ? 
                    `${comparison.toFixed(1)}% mejor` : `${Math.abs(comparison).toFixed(1)}% por mejorar`);
                
                safeUpdateElement('viralMultiplier', (insights.traficoOrganico / 10).toFixed(1) + 'x');
                
            } catch (error) {
                logError("Error en updateROIMetrics", error);
            }
        }

        function updateBrandImpact() {
            try {
                const brandKPIs = filteredData.brandKPIs;
                
                safeUpdateElement('brandInteractionTime', (brandKPIs.tiempoInteraccionMarca / 1000).toFixed(0) + 'K');
                safeUpdateElement('costPerMinute', ' + brandKPIs.costoPorMinutoInteraccion.toFixed(4));
                
                // TV equivalency
                const tvHours = (brandKPIs.tiempoInteraccionMarca / 60).toFixed(0);
                safeUpdateElement('tvEquivalent', tvHours + ' horas de TV');
                
                // TV comparison
                const tvCost = 0.075;
                const efficiency = ((tvCost - brandKPIs.costoPorMinutoInteraccion) / tvCost * 100);
                safeUpdateElement('tvComparison', efficiency > 0 ? 
                    `${efficiency.toFixed(0)}% más eficiente` : 'En análisis');
                
            } catch (error) {
                logError("Error en updateBrandImpact", error);
            }
        }

        function updateCampaignPerformance() {
            try {
                // Top campaigns by ROI
                const topCampaigns = filteredData.campaigns
                    .filter(c => c.plays > 0 && c.spent > 0)
                    .map(c => ({
                        ...c,
                        roi: c.plays / c.spent
                    }))
                    .sort((a, b) => b.roi - a.roi)
                    .slice(0, 5);

                const topList = document.getElementById('topCampaignsList');
                if (!topList) {
                    logError("Elemento topCampaignsList no encontrado", null);
                    return;
                }
                
                topList.innerHTML = '';
                
                if (topCampaigns.length === 0) {
                    topList.innerHTML = '<div class="text-center text-sm opacity-75 py-8">No hay campañas con datos</div>';
                    return;
                }
                
                topCampaigns.forEach((campaign, index) => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-3 bg-white bg-opacity-20 rounded-lg';
                    item.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-yellow-400 rounded-full flex items-center justify-center text-black font-bold text-sm mr-3">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-semibold text-sm">${campaign.name.substring(0, 20)}...</div>
                                <div class="text-xs opacity-75">${campaign.objective}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold">${campaign.roi.toFixed(1)} plays/$</div>
                            <div class="text-xs opacity-75">${campaign.spent.toFixed(0)}</div>
                        </div>
                    `;
                    topList.appendChild(item);
                });

                // Campaign objectives chart
                createCampaignObjectivesChart();
                
            } catch (error) {
                logError("Error en updateCampaignPerformance", error);
            }
        }

        function createCampaignObjectivesChart() {
            const ctx = document.getElementById('campaignObjectivesChart');
            if (!ctx) {
                logError("Canvas campaignObjectivesChart no encontrado", null);
                return;
            }
            
            try {
                if (charts.objectives) {
                    charts.objectives.destroy();
                }
                
                const objectivesData = {};
                filteredData.campaigns.forEach(campaign => {
                    if (!objectivesData[campaign.objective]) {
                        objectivesData[campaign.objective] = { plays: 0, spent: 0 };
                    }
                    objectivesData[campaign.objective].plays += campaign.plays;
                    objectivesData[campaign.objective].spent += campaign.spent;
                });
                
                const labels = Object.keys(objectivesData);
                const data = labels.map(label => objectivesData[label].plays);
                const colors = ['#E31E24', '#4CAF50', '#2196F3', '#FF9800', '#9C27B0'];
                
                charts.objectives = new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'white',
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                logError("Error en createCampaignObjectivesChart", error);
            }
        }

        function updateTrendCharts() {
            createReachEvolutionChart();
            createSessionTimeChart();
        }

        function createReachEvolutionChart() {
            const ctx = document.getElementById('reachEvolutionChart');
            if (!ctx) {
                logError("Canvas reachEvolutionChart no encontrado", null);
                return;
            }
            
            try {
                if (charts.reach) {
                    charts.reach.destroy();
                }
                
                const data = filteredData.experienceMetrics;
                
                charts.reach = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: data.map(d => new Date(d.fecha).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })),
                        datasets: [{
                            label: 'Visitas Acumuladas',
                            data: data.map(d => d.visitasTotales),
                            borderColor: '#E31E24',
                            backgroundColor: 'rgba(227, 30, 36, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            x: {
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            }
                        }
                    }
                });
                
            } catch (error) {
                logError("Error en createReachEvolutionChart", error);
            }
        }

        function createSessionTimeChart() {
            const ctx = document.getElementById('sessionTimeChart');
            if (!ctx) {
                logError("Canvas sessionTimeChart no encontrado", null);
                return;
            }
            
            try {
                if (charts.sessionTime) {
                    charts.sessionTime.destroy();
                }
                
                const data = filteredData.experienceMetrics;
                
                charts.sessionTime = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: data.map(d => new Date(d.fecha).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' })),
                        datasets: [{
                            label: 'Tiempo de Sesión (minutos)',
                            data: data.map(d => d.tiempoSesionPromedio),
                            backgroundColor: data.map(d => {
                                // Color coding basado en el tiempo de sesión
                                if (d.tiempoSesionPromedio >= 4) return '#4CAF50'; // Verde: Excelente
                                if (d.tiempoSesionPromedio >= 3) return '#2196F3'; // Azul: Bueno
                                if (d.tiempoSesionPromedio >= 2) return '#FF9800'; // Naranja: Regular
                                return '#F44336'; // Rojo: Bajo
                            }),
                            borderColor: '#1976D2',
                            borderWidth: 1,
                            borderRadius: 4,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top',
                                labels: { font: { size: 12 } }
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const value = context.parsed.y;
                                        if (value >= 4) return 'Rendimiento: Excelente';
                                        if (value >= 3) return 'Rendimiento: Bueno';
                                        if (value >= 2) return 'Rendimiento: Regular';
                                        return 'Rendimiento: Necesita atención';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { 
                                    display: true, 
                                    text: 'Minutos por Sesión',
                                    font: { size: 12 }
                                },
                                grid: { color: 'rgba(0,0,0,0.1)' }
                            },
                            x: {
                                title: { 
                                    display: true, 
                                    text: 'Fecha',
                                    font: { size: 12 }
                                },
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            }
                        }
                    }
                });
                
            } catch (error) {
                logError("Error en createSessionTimeChart", error);
            }
        }

        function updateExecutiveInsights() {
            try {
                const insights = [
                    {
                        icon: 'fas fa-trophy',
                        color: 'text-green-600',
                        title: 'Performance Sobresaliente',
                        description: `ROI de ${filteredData.advertisingMetrics.playsPerDollar.toFixed(1)} plays/USD supera benchmark industry`,
                        action: 'Mantener estrategia actual'
                    },
                    {
                        icon: 'fas fa-users',
                        color: 'text-blue-600',
                        title: 'Engagement Excepcional',
                        description: `${filteredData.insightsClave.traficoOrganico.toFixed(1)}% de tráfico orgánico indica alto impacto viral`,
                        action: 'Potenciar contenido viral'
                    },
                    {
                        icon: 'fas fa-chart-line',
                        color: 'text-purple-600',
                        title: 'Eficiencia Publicitaria',
                        description: `CPP de ${filteredData.advertisingMetrics.costPerPlay.toFixed(3)} optimiza inversión`,
                        action: 'Escalar presupuesto'
                    }
                ];

                const container = document.getElementById('executiveInsights');
                if (!container) {
                    logError("Elemento executiveInsights no encontrado", null);
                    return;
                }
                
                container.innerHTML = '';
                
                insights.forEach(insight => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 rounded-xl p-6 hover:bg-gray-100 transition-all';
                    card.innerHTML = `
                        <div class="flex items-start">
                            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center mr-4 shadow-sm">
                                <i class="${insight.icon} ${insight.color} text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 mb-2">${insight.title}</h4>
                                <p class="text-sm text-gray-600 mb-3">${insight.description}</p>
                                <div class="inline-flex items-center text-xs font-medium text-blue-600 bg-blue-50 px-3 py-1 rounded-full">
                                    <i class="fas fa-lightbulb mr-1"></i>
                                    ${insight.action}
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
                
            } catch (error) {
                logError("Error en updateExecutiveInsights", error);
            }
        }

        // FUNCIÓN DE FILTRADO MEJORADA
        function filterDataByDate() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate || !dashboardData) {
                    logError("Datos faltantes para filtrar", { startDate, endDate, hasDashboardData: !!dashboardData });
                    return;
                }
                
                // Filter experience metrics (esto se mantiene igual)
                const filteredExperience = dashboardData.experienceMetrics.filter(metric => {
                    return metric.fecha >= startDate && metric.fecha <= endDate;
                });
                
                if (filteredExperience.length === 0) {
                    logError("No hay métricas en el período seleccionado", { startDate, endDate });
                    return;
                }
                
                const lastExperienceMetric = filteredExperience[filteredExperience.length - 1];
                
                // SOLUCIÓN MEJORADA: Categorizar campañas según su relación con el período
                const startDateObj = new Date(startDate);
                const endDateObj = new Date(endDate);
                
                let totalImpressions = 0;
                let totalClicks = 0;
                let totalPlays = 0;
                let totalSpent = 0;
                let campaignsForDisplay = [];
                
                dashboardData.campaigns.forEach(campaign => {
                    const campaignStart = new Date(campaign.startDate);
                    const campaignEnd = new Date(campaign.endDate || campaign.startDate);
                    
                    // Determinar el tipo de relación temporal
                    const isCompletelyInside = campaignStart >= startDateObj && campaignEnd <= endDateObj;
                    const isOverlapping = campaignStart <= endDateObj && campaignEnd >= startDateObj;
                    
                    if (isCompletelyInside) {
                        // Campaña completamente dentro del período: usar datos completos
                        totalImpressions += campaign.impressions;
                        totalClicks += campaign.clicks;
                        totalPlays += campaign.plays;
                        totalSpent += campaign.spent;
                        campaignsForDisplay.push(campaign);
                        
                    } else if (isOverlapping) {
                        // Campaña que se solapa: calcular proporción mejorada
                        const overlapStart = new Date(Math.max(campaignStart.getTime(), startDateObj.getTime()));
                        const overlapEnd = new Date(Math.min(campaignEnd.getTime(), endDateObj.getTime()));
                        
                        // Calcular días de solapamiento con mayor precisión
                        const overlapDays = Math.max(1, Math.ceil((overlapEnd - overlapStart) / (1000 * 60 * 60 * 24)) + 1);
                        const totalCampaignDays = Math.max(1, Math.ceil((campaignEnd - campaignStart) / (1000 * 60 * 60 * 24)) + 1);
                        
                        let proportion = Math.min(1, overlapDays / totalCampaignDays);
                        
                        // Aplicar factor de corrección basado en el tipo de campaña
                        if (campaign.budgetType === 'Daily') {
                            // Para campañas con presupuesto diario, la proporción es más directa
                            proportion = Math.min(1, overlapDays / totalCampaignDays);
                        } else if (campaign.budgetType === 'Lifetime') {
                            // Para campañas con presupuesto total, aplicar factor de distribución
                            if (overlapDays < totalCampaignDays * 0.5) {
                                // Si el solapamiento es menor al 50%, aplicar factor conservador
                                proportion *= 0.7;
                            }
                        }
                        
                        // Evitar incluir métricas muy pequeñas que pueden distorsionar
                        const minThreshold = 0.1; // 10% mínimo
                        if (proportion >= minThreshold) {
                            totalImpressions += Math.round(campaign.impressions * proportion);
                            totalClicks += Math.round(campaign.clicks * proportion);
                            totalPlays += Math.round(campaign.plays * proportion);
                            totalSpent += campaign.spent * proportion;
                            
                            // Crear copia de campaña con métricas ajustadas para display
                            const adjustedCampaign = {
                                ...campaign,
                                impressions: Math.round(campaign.impressions * proportion),
                                clicks: Math.round(campaign.clicks * proportion),
                                plays: Math.round(campaign.plays * proportion),
                                spent: Math.round(campaign.spent * proportion * 100) / 100,
                                _isAdjusted: true,
                                _proportion: proportion
                            };
                            campaignsForDisplay.push(adjustedCampaign);
                        }
                    }
                });
                
                // Validación de datos mínimos
                if (totalSpent < 1 || totalImpressions < 100) {
                    // Usar datos del período más amplio si las métricas son muy bajas
                    console.warn("Métricas muy bajas en período seleccionado, expandiendo búsqueda...");
                    
                    // Buscar campañas en un rango más amplio (±7 días)
                    const expandedStart = new Date(startDateObj.getTime() - 7 * 24 * 60 * 60 * 1000);
                    const expandedEnd = new Date(endDateObj.getTime() + 7 * 24 * 60 * 60 * 1000);
                    
                    dashboardData.campaigns.forEach(campaign => {
                        const campaignStart = new Date(campaign.startDate);
                        const campaignEnd = new Date(campaign.endDate || campaign.startDate);
                        
                        if (campaignStart <= expandedEnd && campaignEnd >= expandedStart) {
                            const hasOverlap = campaignsForDisplay.some(c => c.campaignId === campaign.campaignId);
                            if (!hasOverlap && campaign.plays > 0) {
                                // Aplicar factor de relevancia reducido
                                const relevanceFactor = 0.3;
                                totalImpressions += Math.round(campaign.impressions * relevanceFactor);
                                totalClicks += Math.round(campaign.clicks * relevanceFactor);
                                totalPlays += Math.round(campaign.plays * relevanceFactor);
                                totalSpent += campaign.spent * relevanceFactor;
                            }
                        }
                    });
                }
                
                // Cálculo de métricas derivadas con validaciones
                const overallCTR = totalImpressions > 0 ? (totalClicks / totalImpressions * 100) : 0;
                const overallPlayRate = totalImpressions > 0 ? (totalPlays / totalImpressions * 100) : 0;
                const costPerPlay = totalPlays > 0 ? (totalSpent / totalPlays) : 0;
                const costPerClick = totalClicks > 0 ? (totalSpent / totalClicks) : 0;
                const clickToPlayRate = totalClicks > 0 ? (totalPlays / totalClicks * 100) : 0;
                const playsPerDollar = totalSpent > 0 ? (totalPlays / totalSpent) : 0;
                
                // Brand KPIs usando la métrica más reciente del período
                const tiempoInteraccionMarca = lastExperienceMetric.visitasTotales * lastExperienceMetric.tiempoSesionPromedio;
                const costoPorMinutoInteraccion = tiempoInteraccionMarca > 0 ? (totalSpent / tiempoInteraccionMarca) : 0;
                
                // Tráfico orgánico ajustado
                const playsOrganicosEstimados = Math.max(0, lastExperienceMetric.visitasTotales - totalPlays);
                const traficoOrganico = lastExperienceMetric.visitasTotales > 0 ? 
                    (playsOrganicosEstimados / lastExperienceMetric.visitasTotales * 100) : 0;
                
                // Actualizar filteredData con validaciones
                filteredData = {
                    ...dashboardData,
                    experienceMetrics: filteredExperience,
                    campaigns: campaignsForDisplay,
                    advertisingMetrics: {
                        totalImpressions: Math.max(0, totalImpressions),
                        totalClicks: Math.max(0, totalClicks),
                        totalPlays: Math.max(0, totalPlays),
                        totalSpent: Math.max(0, Math.round(totalSpent * 100) / 100),
                        overallCTR: Math.round(Math.max(0, overallCTR) * 100) / 100,
                        overallPlayRate: Math.round(Math.max(0, overallPlayRate) * 100) / 100,
                        costPerPlay: Math.max(0, Math.round(costPerPlay * 1000) / 1000),
                        costPerClick: Math.max(0, Math.round(costPerClick * 1000) / 1000),
                        clickToPlayRate: Math.max(0, Math.round(clickToPlayRate * 100) / 100),
                        playsPerDollar: Math.max(0, Math.round(playsPerDollar * 10) / 10)
                    },
                    brandKPIs: {
                        tiempoInteraccionMarca: Math.max(0, Math.round(tiempoInteraccionMarca)),
                        costoPorMinutoInteraccion: Math.max(0, Math.round(costoPorMinutoInteraccion * 10000) / 10000)
                    },
                    insightsClave: {
                        roiPublicitario: Math.max(0, Math.round(playsPerDollar * 10) / 10),
                        traficoOrganico: Math.max(0, Math.min(100, Math.round(traficoOrganico * 10) / 10)),
                        eficienciaConversion: Math.max(0, Math.min(100, Math.round(clickToPlayRate * 10) / 10))
                    }
                };
                
                updateExecutiveDashboard();
                
                // Información del filtro mejorada
                const filterInfo = document.getElementById('filterInfo');
                if (filterInfo) {
                    const totalCampaigns = campaignsForDisplay.length;
                    const adjustedCampaigns = campaignsForDisplay.filter(c => c._isAdjusted).length;
                    
                    let statusText = `📊 Período: ${startDate} a ${endDate} | `;
                    statusText += `Visitas: ${lastExperienceMetric.visitasTotales.toLocaleString()} | `;
                    statusText += `Campañas: ${totalCampaigns} ${adjustedCampaigns > 0 ? `(${adjustedCampaigns} ajustadas)` : ''} | `;
                    statusText += `Inversión: ${totalSpent.toFixed(0)} | `;
                    statusText += `ROI: ${playsPerDollar.toFixed(1)} plays/USD`;
                    
                    filterInfo.textContent = statusText;
                    filterInfo.className = 'mt-3 text-sm font-medium ' + 
                        (totalSpent > 100 ? 'text-green-600' : totalSpent > 10 ? 'text-blue-600' : 'text-orange-600');
                }
                
                logInfo("Filtro aplicado con método mejorado", {
                    período: `${startDate} a ${endDate}`,
                    métricas: filteredExperience.length,
                    campañasTotal: campaignsForDisplay.length,
                    campañasAjustadas: campaignsForDisplay.filter(c => c._isAdjusted).length,
                    gastoTotal: totalSpent.toFixed(2),
                    impresiones: totalImpressions.toLocaleString(),
                    metodología: 'Híbrida mejorada'
                });
                
            } catch (error) {
                logError("Error en filterDataByDate mejorado", error);
            }
        }

        // Event listeners
        document.getElementById('applyFilter').addEventListener('click', filterDataByDate);
        
        document.getElementById('resetFilter').addEventListener('click', () => {
            try {
                if (dashboardData) {
                    const dates = dashboardData.experienceMetrics.map(d => d.fecha).sort();
                    document.getElementById('startDate').value = dates[0];
                    document.getElementById('endDate').value = dates[dates.length - 1];
                    filteredData = JSON.parse(JSON.stringify(dashboardData));
                    updateExecutiveDashboard();
                    
                    const filterInfo = document.getElementById('filterInfo');
                    if (filterInfo) {
                        filterInfo.textContent = '📈 Vista completa: Todos los datos de la campaña';
                    }
                    
                    logInfo("Filtro reseteado", "Vista completa restaurada");
                }
            } catch (error) {
                logError("Error en reset filter", error);
            }
        });

        // Initialize executive dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            logInfo("DOM cargado", "Iniciando carga de dashboard");
            loadData();
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            logError("Error global capturado", {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
        });
    </script>
</body>
</html>
